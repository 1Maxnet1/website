---
title: "Flashing"
draft: false
menu:
  docs:
    title:
    parent: "Ox64/Software"
    identifier: "Ox64/Software/Flashing"
    weight: 3
---

This page explains how to flash an Ox64 board and a microSD card to boot the system.

== Prepare the environment
You need a Linux machine, a Raspberry Pi Pico to act as a UART adapter, the Ox64 board, and a microSD card.

First, download the Raspberry Pi Pico firmware that allows it to act as a serial adapter.
You may skip this step if you are using your own serial adapter.
(But see link:/documentation/Ox64/Further_information/Compatible_UARTs/[Compatible_UARTs]
and <<using_a_serial_adapter_other_than_the_pico>>.)

 mkdir -p ~/ox64/pico
 cd ~/ox64/pico
 wget https://github.com/Kris-Sekula/Pine64_Ox64_SBC/raw/main/uart/picoprobe.uf2

Next, download the Ox64 images from the latest OpenBouffalo release. You may skip this step if
you built your own images as per the instructions in the
link:/documentation/Ox64/Software/Building/[Building] section.

 mkdir -p ~/ox64/openbouffalo
 cd ~/ox64/openbouffalo
 wget https://github.com/openbouffalo/buildroot_bouffalo/releases/download/v1.0.1/bl808-linux-pine64_ox64_full_defconfig.tar.gz
 tar -xvzf bl808-linux-pine64_ox64_full_defconfig.tar.gz

NOTE: If you built your own images, substitute `~/ox64/openbouffalo` with
`~/ox64/buildroot/output/images` in all instructions that follow.

In any case, verify that you have all the required image files:

* `m0_lowload_bl808_m0.bin` -- Startup code for the M0 core.
* `d0_lowload_bl808_d0.bin` -- Startup code for the D0 core.
* `bl808-firmware.bin` -- OpenSBI and UBoot DTB files. Runs on the D0 core.
* `sdcard.img` -- Kernel and root filesystem. Runs on the D0 core.

Next, download the latest DevCube flashing tool from BouffaloLab's website. You may skip this
step if you are using the <<cli_flashing_method>>.

 mkdir -p ~/ox64/devcube
 cd ~/ox64/devcube
 wget https://dev.bouffalolab.com/media/upload/download/BouffaloLabDevCube-v1.8.8.zip
 unzip BouffaloLabDevCube-v1.8.8.zip
 chmod u+x BLDevCube-ubuntu

If you are not creating a <<optional_create_a_combined_soc_image, combined image>> you may need
an older version of the DevCube. In that case, download v1.8.3 from one of the mirrors below:

* https://openbouffalo.org/static-assets/bldevcube/BouffaloLabDevCube-v1.8.3.zip
* https://hachyderm.io/@mkroman/110787218805897192 > https://pub.rwx.im/~mk/bouffalolab/BouffaloLabDevCube-v1.8.3.zip
* https://we.tl/t-eJWShQJ4iF
* https://cdn.discordapp.com/attachments/771032441971802142/1145565853962735639/BouffaloLabDevCube-v1.8.3.zip

Verify that your copy of `BouffaloLabDevCube-v1.8.3.zip` matches the hashes below:

* SHA1: `0f2619e87d946f936f63ae97b0efd674357b1166`
* SHA256: `e6e6db316359da40d29971a1889d41c9e97d5b1ff1a8636e9e6960b6ff960913`

== Optional: create a combined SoC image
Use the following commands to combine `m0_lowload_bl808_m0.bin`, `d0_lowload_bl808_d0.bin`, and
`bl808-firmware.bin` into a single image. This is mainly useful for troubleshooting
(e.g. when using DevCube v1.8.4+).

----
cd ~/ox64/openbouffalo

fallocate -l 0x800000 bl808-combined.bin
dd conv=notrunc if=m0_lowload_bl808_m0.bin of=bl808-combined.bin
dd conv=notrunc if=d0_lowload_bl808_d0.bin of=bl808-combined.bin seek=$((0x100000))B
cat bl808-firmware.bin >> bl808-combined.bin
----

== Establish serial communication from PC to Ox64 using Pi Pico

Put the Raspberry Pi Pico board into programming mode.

* Press the BootSel button
* Apply power by plugging the USB cable to PC
* Release the BootSel button

NOTE: As an alternative to pressing the BootSel button, you can also connect the probe point `TP6`
(located on the bottom of the Pico board) to any ground point (e.g. pin 28).

Copy `picoprobe.uf2` file into the new device `/media/<user>/RPI-RP2`.

 cp ~/ox64/pico/picoprobe.uf2 /media/<user>/RPI-RP2

After flashing, verify that you have two serial interfaces (when the Pico is connected to your PC):

----
$ ls /dev/ttyACM*

/dev/ttyACM0
/dev/ttyACM1
----

Next, connect the Ox64 board to the Pico according to the following wiring diagram:

 OX64                      PI PICO
 uart0_Tx_GPIO14_pin1 <->  uart0_Rx_pin17
 uart0_Rx_GPIO15_pin2 <->  uart0_Tx_pin16
 Rxd_GPIO17_pin31     <->  uart1_Tx_pin6
 Txd_GPIO16_pin32     <->  uart1_Rx_pin7 
 gnd_pin38            <->  gnd_pin38/3    
 vbus5v_pin40         <->  vbus5v_pin40

[NOTE]
====
With the Pico flashed and wired as per the instructions above, we have access to two of the
Ox64's UART connections at the same time.

* `/dev/ttyACM0` connects to the D0 core's (i.e. Linux's) serial console
* `/dev/ttyACM1` is used for flashing (but also connects to the M0 core's serial console)

This configuration eliminates the need to switch the physical connections to the Ox64 board
between flashing and testing the system.
====

== Flashing the Ox64
Put the Ox64 into programming mode:

* Press the BOOT button
* Apply power or re-plug the USB cable
* Release the BOOT button

=== BLDevCube flashing method

Open a new terminal window to run the DevCube flasher.

 cd ~/ox64/devcube
 ./BLDevCube-ubuntu

Select chip [BL808], press Finish, and configure BOTH the [MCU] and [IOT] tabs as follows.
When you switch between tabs double check that they still match the settings below.

 Interface: UART
 Port/SN: /dev/ttyACM1 (make sure you don't use /dev/ttyACM0, it's used by the minicom console)
 Uart rate 230400 (safe value for macOS, if using Linux set to 2000000 for faster flashing)

If you created a **combined image** then you only need to use the [IOT] tab:

 Enable 'Single Download'
 Image Address [0x0], [PATH to bl808-combined.bin]
 Click 'Create & Download' and wait until it's done
 Close DevCube

Otherwise, start in the [MCU] tab:

 M0 Group[group0], Image Address [0x58000000], [PATH to m0_lowload_bl808_m0.bin]
 D0 Group[group0], Image Address [0x58100000], [PATH to d0_lowload_bl808_d0.bin]
 Click 'Create & Download' and wait until it's done

Then, switch to the [IOT] tab and set:

 Enable 'Single Download'
 Image Address [0x800000], [PATH to bl808-firmware.bin]
 Click 'Create & Download' again and wait until it's done
 Close DevCube

=== CLI flashing method
For those who do not want to use the DevCube, BouffaloLab provides open-source flashing packages `bflb-iot-tool` and `bflb-mcu-tool`.

First, install `bflb-iot-tool` using your preferred method of managing PIP packages. One option is to set up a Python virtual environment as follows.

----
sudo apt install python3-venv

python3 -m venv ~/ox64_venv
. ~/ox64_venv/bin/activate
pip install bflb-iot-tool # we are *not* using bflb-mcu-tool
----

NOTE: Each time you open a new terminal window you will need to re-run `. ~/ox64_venv/bin/activate` to reactivate the virtual environment.

Next, set up some environment variables to save typing them out later:

 PORT=/dev/ttyACM1 # this will depend on which serial adapter you use
 BAUD=230400       # safe value for macOS, if using Linux set to 2000000 for faster flashing

Change directory to the location of your image files:

 cd ~/ox64/openbouffalo

Finally, flash the Ox64. If you created a **combined image** then run the following command:

 bflb-iot-tool --chipname bl808 --interface uart --port $PORT --baudrate $BAUD --addr 0x0 \
               --firmware bl808-combined.bin  --single

Otherwise:

----
bflb-iot-tool --chipname bl808 --interface uart --port $PORT --baudrate $BAUD --addr 0x0 \
              --firmware m0_lowload_bl808_m0.bin --single

bflb-iot-tool --chipname bl808 --interface uart --port $PORT --baudrate $BAUD --addr 0x100000 \
              --firmware d0_lowload_bl808_d0.bin --single

bflb-iot-tool --chipname bl808 --interface uart --port $PORT --baudrate $BAUD --addr 0x800000 \
              --firmware bl808-firmware.bin --single
----

If you get permission errors when running any of the commands above, you may need to add your user to the `dialout` group. Running the commands as `root` is not recommended since this will make `bflb-iot-tool` create root-owned files in your home directory.


== Flashing the microSD card

Insert the microSD card into your PC, locate its device file (`/dev/sdb`, for example), and write the image:

 cd ~/ox64/openbouffalo
 sudo dd if=sdcard.img of=/dev/sdb bs=1M status=progress conv=fsync

== Booting for the first time

Insert the microSD card into your Ox64 and open a UART connection to the Ox64 board:

 minicom -b 2000000 -D /dev/ttyACM0

Re-apply power to the Ox64 and you will see Linux booting up. When prompted, log in
as `root` with no password.


== Appendix

=== Using a serial adapter other than the Pico
If you are using one of the
link:/documentation/Ox64/Further_information/Compatible_UARTs/[supported UART adapters]
that isn't the Pico, you will only have one serial interface available to you. For the purposes
of this guide, let's say it is `/dev/ttyUSB0`.

In addition, you will need a way of powering your Ox64. If your serial adapter has a 5V line,
you can connect it to VBUS (pin 40). Otherwise, you can connect either the micro-B or the
USB-C port on the Ox64 to any 5V power supply.

Refer to the pinout image below. Connect your UART adapter as follows:

* RX -> UART0_TX / GPIO14 / pin 1
* TX -> UART0_RX / GPIO15 / pin 2
* GND -> any ground (e.g. pin 3)

Then, follow the instructions in <<flashing_the_ox64>> and <<flashing_the_microsd_card>>, but
replace all occurrences of `/dev/ttyACM1` with `/dev/ttyUSB0`.

Next, power off the Ox64 and re-connect your UART adapter as follows:

* RX -> TXD / GPIO16 / pin 32
* TX -> RXD / GPIO17 / pin 31
* GND -> any ground (e.g. pin 33)

Then, follow the instructions in <<booting_for_the_first_time>>, but replace all occurrences of
`/dev/ttyACM0` with `/dev/ttyUSB0`. You should now have a working Linux system.

image:/documentation/Ox64/images/ox64_pinout.png[Pinout of the production version,title="Pinout of the production version", 300]

=== Adding Nuttx RTOS

Get Nuttx image from lupyen's github page. More info on building on https://nuttx.apache.org/docs/latest/platforms/risc-v/bl808/boards/ox64/index.html.

 mkdir -p ~/ox64/nuttx
 cd ~/ox64/nuttx
 wget https://github.com/lupyuen2/wip-pinephone-nuttx/releases/download/bl808d-1/Image
 sudo mv Image ImageNuttx

Wipe beginning of the microSD card.

 sudo dd if=/dev/zero of=/dev/sdb count=1 bs=32768 status=progress

Before removing partitions, if you need to remove also left signatures, use gParted and format each partition "cleared". Than remove all partitions with gParted.

 sudo wipefs /dev/sdb # shows current signatures
 sudo wipefs --all --force /dev/sdb # erase current signatures

Partition the microSD card.

 sudo sfdisk /dev/sdb --wipe always <<EOF
  label: gpt
  first-lba: 34
  table-length: 8
  start=34, size=2097152, type=linuxswap, name="swap"
  size=210MB, name="boot", attrs="RequiredPartition,LegacyBIOSBootable"
  size=537MB, name="rootfs", attrs="RequiredPartition,LegacyBIOSBootable"
  size=+, name="extra", attrs="RequiredPartition,LegacyBIOSBootable"
 EOF

Mount the `sdcard.img` image, copy `boot` and `rootfs`. Add `ImageNuttx` and edit `/extlinux/extlinux.conf` to add a new Nuttx boot option.

 cd ~/ox64/openbouffalo
 sudo losetup -P /dev/loop1 sdcard.img

 sudo dd if=/dev/loop1p2 of=/dev/sdb2 bs=1M status=progress conv=fsync
 sudo mkdir /mnt/nuttx_boot_sd
 sudo mount /dev/sdb2 /mnt/nuttx_boot_sd/
 sudo scp -r ~/ox64/nuttx/ImageNuttx /mnt/nuttx_boot_sd

 cd /mnt/nuttx_boot_sd/extlinux
 sudo nano extlinux.conf
 # add following lines, without the `+` character
 +LABEL Pine64 0X64 Nuttx
 +        KERNEL ../ImageNuttx
 +        FDT ../bl808-pine64-ox64.dtb
 +        APPEND root=PARTLABEL=rootfs rootwait rw rootfstype=ext4 console=ttyS0,2000000 loglevel=8 earlycon=sbi

 sudo dd if=/dev/loop1p3 of=/dev/sdb3 bs=1M status=progress conv=fsync
 sudo mkdir /mnt/nuttx_rootfs_sd
 sudo mount /dev/sdb3 /mnt/nuttx_rootfs_sd/
 sudo scp -r ~/ox64/nuttx/ImageNuttx /mnt/nuttx_rootfs_sd/boot

 cd /mnt/nuttx_rootfs_sd/boot/extlinux
 sudo nano extlinux.conf
 # add following lines, without the `+` character
 +LABEL Pine64 0X64 Nuttx
 +        KERNEL ../ImageNuttx
 +        FDT ../bl808-pine64-ox64.dtb
 +        APPEND root=PARTLABEL=rootfs rootwait rw rootfstype=ext4 console=ttyS0,2000000 loglevel=8 earlycon=sbi

Do some cleaning

 sudo umount /mnt/* && sudo rm -r /mnt/*
 sudo umount /media/* && sudo rm -r /media/*
 sudo losetup -D

Enjoy your new Nuttx booting option!
